name: Build and push image

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  IMAGE_NAME: relistenapi                 # <‑‑ repo/image name in the registry
  REGISTRY_DOMAIN: 100.97.22.118
  REGISTRY_PORT: 32000
  TAG: latest   
  
jobs:

  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Tailscale
      uses: tailscale/github-action@v3
      with:
        oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
        use-cache: 'true'
        tags: tag:ci
        version: latest

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        config-inline: |
          [registry."${{ env.REGISTRY_DOMAIN }}"]
            http = true
            insecure = true

    - name: Build and push image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64          # x86_64
        tags: ${{ env.REGISTRY_DOMAIN }}:${{ env.REGISTRY_PORT }}/${{ env.IMAGE_NAME }}:${{ env.TAG }}
        push: true
